---
navigation:
  - oci8.fan.md: « Поддержка OCI8 Fast Application Notification (FAN)
  - oci8.dtrace.md: OCI8 та динамічне трасування DTrace »
  - index.md: PHP Manual
  - book.oci8.md: OCI8
title: >-
  Підтримка прозорого для програм відновлення після відмови (Transparent
  Application Failover або TAF) для OCI8
---
# Підтримка прозорого для програм відновлення після відмови (Transparent Application Failover або TAF) для OCI8

TAF - це механізм бази даних Oracle, що забезпечує високу доступність. Він дозволяє програмам PHP, що використовують OCI8, автоматично перепідключатися до резервної бази даних у разі збою на основний або при мережевих проблемах.

У конфігурованій системі бази даних Oracle, TAF відбувається коли програма PHP визначає, що екземпляр бази даних недоступний. У цьому випадку відбувається з'єднання з іншим вузлом Oracle [» RAC](https://www.oracle.com/pls/topic/lookup?ctx=dblatest&id=GUID-DEF850F6-27E9-428E-B8FC-530230D78AD2). Це може бути гарячий резерв або той самий екземпляр бази даних. Докладніше про OCI TAF читайте у [» Oracle Call Interface Programmer's Guide](https://www.oracle.com/pls/topic/lookup?ctx=dblatest&id=GUID-F7817CD2-4A2C-4D37-BD36-56DBABD4725F)

Функцію зворотного дзвінка для програми можна зареєструвати за допомогою [ociregistertafcallback()](function.oci-register-taf-callback.md). У процесі відновлення після відмови виконання програми буде призупинено та буде викликана зареєстрована функція зворотного дзвінка. Ця функція сповіщатиме про програму відновлення. Якщо відновлення завершилося успішно, керування буде повернено програмі. Якщо відновлення завершилося невдало, всі наступні звернення до базі даних будуть завершуватися з помилкою, оскільки відсутня підключення.

Коли з'єднання переходить до іншої бази даних, зворотний виклик може скинути будь-який необхідний стан з'єднання, наприклад, перевиконати будь-яку необхідну команду ALTER SESSION якщо для сервісу бази даних не включено -failoverrestore.

Реєстрацію функції зворотного дзвінка можна видалити за допомогою [ociunregistertafcallback()](function.oci-unregister-taf-callback.md)

## налаштування TAF

TAF можна настроїти на стороні PHP OCI8 або конфігурації бази даних. Якщо налаштовано там і там, то перевага віддається налаштувань за бази даних.

Налаштувати TAF в PHP OCI8 (на стороні клієнта) можна, додавши параметр FAILOVERMODE у частині CONNECTDATA дескриптора з'єднання. Докладніше про налаштування TAF на стороні клієнта читайте у [»  Oracle Database Net Services Administrator's Guide](https://www.oracle.com/pls/topic/lookup?ctx=dblatest&id=GUID-8F532535-C401-4B51-BE0B-04FD74BB0621)

Приклад налаштування TAF в tnsnames.ora для перепідключення до тієї ж БД:

```
ORCL =
      (DESCRIPTION =
        (ADDRESS = (PROTOCOL = TCP)(HOST = 127.0.0.1)(PORT = 1521))
        (CONNECT_DATA =
          (SERVICE_NAME = orclpdb1)
          (FAILOVER_MODE =
            (TYPE = SELECT)
            (METHOD = BASIC)
            (RETRIES = 20)
            (DELAY = 15))))
```

Також можна налаштувати TAF на стороні бази даних шляхом модифікації сервісу за допомогою [» srvctl](https://www.oracle.com/pls/topic/lookup?ctx=dblatest&id=GUID-8DC4D5E0-CA9D-47BC-BAD0-8769405AFEC5) (для RAC) або за допомогою пакетної процедури [»  DBMSSERVICE.MODIFYSERVICE](https://www.oracle.com/pls/topic/lookup?ctx=dblatest&id=GUID-C11449DC-EEDE-4BB8-9D2C-0A45198C1928) (Для одиночних екземплярів баз даних).

## Використання функцій зворотного дзвінка TAF у OCI8

Функція зворотного виклику TAF є функцією, зареєстрованою з програми для запуску в процесі відновлення після збою. При відновленні з'єднання вона викликається кілька разів.

Перший раз вона запускається у момент виявлення проблем із з'єднанням. Це дозволяє програмі коректно підготуватися до затримки виконання на час відновлення після збою. Якщо відновлення завершилося успішно, функція буде викликана відразу після відновлення підключення. Цей запуск програма може використовувати для пересинхронізації налаштувань сесії та оповіщення користувача про те, що відбулося відновлення після збою. Якщо відновлення завершилося невдало, функція запускається ще раз для оповіщення програми про те, що відновлення завершилося з помилкою і з'єднання з базою даних недоступне.

Інтерфейс функції зворотного виклику TAF:

```methodsynopsis
userCallbackFn(resource $connection, int $event, int $type): int
```

`connection`

Ідентифікатор з'єднання Oracle, для якого ця функція була зареєстрована за допомогою [ociregistertafcallback()](function.oci-register-taf-callback.md). З'єднання недоступне під час аварійного відновлення.

`event`

Подія відновлення означає поточний статус відновлення.

-   **`OCI_FO_BEGIN`** означає, що відбулася втрата з'єднання та процес відновлення розпочато.
    
-   **`OCI_FO_END`** означає вдале відновлення з'єднання.
    
-   **`OCI_FO_ABORT`** означає, що відновлення завершилося невдало і спроб відновлення більше не буде.
    
-   **`OCI_FO_ERROR`** також означає, що відновлення завершилося з помилкою, але програма дає можливість обробити помилку і повернути OCIФОRETRY ще для однієї спроби відновлення.
    
-   **`OCI_FO_REAUTH`** означає, що користувач Oracle був повторно автентифікований.
    

`type`

Тип відновлення після відмови. Це дозволяє функціям зрозуміти, який тип відновлення запрошений програмою. Допустимі такі значення:

-   **`OCI_FO_SESSION`** означає, що користувач запросив лише відновлення сесії. Наприклад, якщо з'єднання зникло, буде створена нова сесія на резервному сервері. Цей тип відновлення не намагатиметься відновити запити типу SELECT.
    
-   **`OCI_FO_SELECT`** означає, що запит запитів SELECT запитано. Це дозволить використовувати відкритий курсор для отримання значень після відновлення.
    

`return value`

-   **`0`** означає, що кроки відновлення після відмови мають тривати нормально.
    
-   **`OCI_FO_RETRY`** означає, що потрібно спробувати знову відновитися. У разі виникнення помилки під час переходу на нове з'єднання TAF може повторити перехід на інший ресурс. Зазвичай перед поверненням коду OCIФОRETRY рекомендується деякий час зачекати.
    

Приклад реєстрації функції зворотного дзвінка TAF

```php
<?php

// Определяем функцию обратного вызова в пространстве пользователя
class MyClass {
    public static $retry_count;
    public static function TAFCallback($conn, $event, $type)
    {
        switch ($event) {
            case OCI_FO_BEGIN:
                printf(" Failing Over ... Please stand by\n");
                printf(" Failover type was found to be %s \n",
                       (($type==OCI_FO_SESSION) ? "SESSION"
                        :(($type==OCI_FO_SELECT) ? "SELECT" : "UNKNOWN!")));
                self::$retry_count = 0;
                break;
            case OCI_FO_ABORT:
                // Приложение больше не может использовать базу данных
                printf(" Восстановление невозможно.\n");
                break;
            case OCI_FO_END:
                // Восстановление завершилось успешно. Оповестим пользователей, что была проблема.
                printf(" Восстановление завершено ... восстанавливаю работу\n");
                break;
            case OCI_FO_REAUTH:
                printf(" Пользователь переавторизован ... восстанавливаю работу\n");
                // Заново выполняем все необходимые ALTER SESSION
                // т.е. oci_parse($conn, ‘ALTER SESSION …’) ;
                break;
            case OCI_FO_ERROR:
                // Прекращаем попытки соединения, если их было более 20.
                if (self::$retry_count >= 20)
                    return 0;
                printf(" Ошибка восстановления. Повторная попытка через 10 секунд...\n");
                sleep(10);
                self::$retry_count++;
                return OCI_FO_RETRY; // retry failover
                break;
            default:
                printf("Неизвестное событие восстановления: %d.\n", $event);
                break;
        }
        return 0;
    }
}

$fn_name = 'MyClass::TAFCallback';

$conn = oci_connect('hr', 'welcome', 'orcl');
$sysconn = oci_connect('system', 'oracle', 'orcl');

// Используйте привилегированное соединение для создания оператора SQL, который будет инициировать отработку отказа
$sql = <<< 'END'
select unique 'alter system disconnect session '''||sid||','||serial#||''''
from v$session_connect_info
where sid = sys_context('USERENV', 'SID')
END;

$s = oci_parse($conn, $sql);
oci_execute($s);
$r = oci_fetch_array($s);
$disconnectssql = $r[0];

oci_register_taf_callback($conn, $fn_name); // Зарегистрируйте TAFCallback для Oracle TAF

print("Разбор пользовательского запроса\n");
$sql = "select systimestamp from dual";
$stmt = oci_parse($conn, $sql);

// К примеру, если соединение было потеряно на этом шаге, oci_execute()
// определит это и запустит процедуру восстановления. В процессе восстановления
// oci_execute() будет вызовать зарегистрированную функцию обратного вызова
// несколько раз. Если восстановление пройдёт успешно, то будет создано новое соединение
// и выполнение oci_execute() будет продолжено в нормальном режиме.
// Настройки сессии могут быть сброшены в функции обратного вызова.
// Если восстановление завершится неудачно, oci_execute() вернёт ошибку, так как
// будет отсутствовать соединение.

// Отключите пользователя, который инициирует аварийное переключение
print("Отключение пользователя\n");
$discsql = oci_parse($sysconn, $disconnectssql);
oci_execute($discsql);

print("Выполнение пользовательского запроса\n");
$e = oci_execute($stmt);
if (!$e) {
    $m = oci_error($stmt);
    trigger_error('Не удалось выполнить условие:'. $m['message'], E_USER_ERROR);
}
$row = oci_fetch_array($stmt);
print($row[0] . "\n");

// выполняем другие SQL-запросы на новом подключении
// $stmt = oci_parse($conn,  . . .);

?>
```

## Також дивіться

-   [ociregistertafcallback()](function.oci-register-taf-callback.md)
-   [ociunregistertafcallback()](function.oci-unregister-taf-callback.md)
