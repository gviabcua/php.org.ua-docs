Обробка з'єднання та сталість

-   [« Архитектура](mongodb.overview.html)
    
-   [Постоянные данные »](mongodb.persistence.html)
    
-   [PHP Manual](index.html)
    
-   [Архитектура и внутреннее устройство драйвера](mongodb.architecture.html)
    
-   Обробка з'єднання та сталість
    

# Обробка з'єднання та сталість

> **Зауваження**: На Unix, драйвер MongoDB чутливий до сценаріїв, які використовують системний виклик fork() без наступного exec(). Користувачам рекомендується не перевикористовувати екземпляр [MongoDB\\Driver\\Manager](class.mongodb-driver-manager.html) у дочірньому процесі. child process.

## Постійність підключення та топології (версія PHP починаючи з 1.2.0)

Усі версії драйвера, починаючи з 1.2.0, зберігають клієнтський об'єкт [» libmongoc](https://github.com/mongodb/mongo-c-driver) у робочому процесі PHP, що дозволяє йому повторно використовувати з'єднання з базою даних, стану аутентифікації *і* інформацію про топологію у кількох запитах.

Коли викликається [MongoDB\\Driver\\Manager::\_\_construct()](mongodb-driver-manager.construct.html), З його аргументів створюється хеш (тобто рядок URI та параметри масиву). Драйвер спробує знайти раніше збережений клієнтський об'єкт [» libmongoc](https://github.com/mongodb/mongo-c-driver) для цього хеша. Якщо існуючий клієнт не може бути знайдений для хеша, буде створено новий клієнт (і буде збережено для майбутнього використання).

Кожен клієнт містить свої власні підключення до бази даних та представлення топології сервера (наприклад, автономний, набір реплік, кластер сегментів). Зберігаючи клієнт між запитами PHP, драйвер може повторно використовувати встановлені підключення до бази даних та усувати потребу [» обнаружения топологии сервера](https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst) при кожному запиті.

Розглянемо наступний приклад:

```php
<?php

$managers = [
    new MongoDB\Driver\Manager('mongodb://127.0.0.1'),
    new MongoDB\Driver\Manager('mongodb://127.0.0.1'),
    new MongoDB\Driver\Manager('mongodb://127.0.0.1:27017'),
    new MongoDB\Driver\Manager('mongodb://rs1.example.com,rs2.example.com/', ['replicaSet' => 'myReplicaSet']),
];

foreach ($managers as $manager) {
    $manager->executeCommand('test', new MongoDB\Driver\Command(['ping' => 1]));
}

?>
```

Перші два об'єкти Manager будуть використовувати один і той самий клієнт [» libmongoc](https://github.com/mongodb/mongo-c-driver)оскільки їх аргументи конструктора ідентичні. Третій та четвертий об'єкти будуть використовувати кожен свій клієнт. Всього буде створено три клієнти, і процес PHP, який виконує цей скрипт, відкриє два з'єднання з `127.0.0.1` і одне з'єднання з кожним з `rs1.example.com` і `rs2.example.com`. Якщо драйвер виявляє додаткових членів набору реплік після виконання команд `hello`, також відкриває додаткові підключення до цих серверів.

Якщо цей процес знову виконає сценарій у другому запиті, ці три клієнти будуть використані повторно, і нові підключення не будуть виконуватися. Залежно від того, як давно було опрацьовано попередній запит, драйверу може знадобитися виконати додаткові команди. `hello` для поновлення свого представлення топологій.

## Постійність сокетів (версії PHP до 1.2.0)

Версії драйвера PHP до 1.2.0 використовують PHP's Streams API для з'єднань з базою даних, використовуючи API в [» libmongoc](https://github.com/mongodb/mongo-c-driver) для визначення користувальницьких обробників для зв'язку із сокетами; однак новий клієнт libmongoc створюється для кожного [MongoDB\\Driver\\Manager](class.mongodb-driver-manager.html). В результаті драйвер зберігає окремі з'єднання з базою даних, але не інформацію про стан автентифікації чи топології. Це означає, що драйвер повинен видавати команди на початку кожного запиту для автентифікації та [» обнаружения топологии сервера](https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst)

З'єднання з базою даних зберігаються за допомогою хеша, отриманого з хоста, порту та рядка URI сервера, що використовується для побудови [MongoDB\\Driver\\Manager](class.mongodb-driver-manager.html). Параметри масиву конструктора не включені до цього хеша.

> **Зауваження**: Версії драйвер >= 1.1.8 and < 1.2.0 не зберігають сокети для з'єднань SSL. Дивіться [» PHPC-720](https://jira.mongodb.org/browse/PHPC-720) для отримання додаткової інформації.

Незважаючи на недоліки, пов'язані зі збереженням з'єднань SSL та інформацією про топологію, ця версія драйвера підтримує все [параметры контекста SSL](context.ssl.html), оскільки використовує PHP Streams API.