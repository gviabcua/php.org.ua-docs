Зміни, що ламають зворотну сумісність

-   [« Новые глобальные константы](migration71.constants.html)
    
-   [Функционал, объявленный устаревшим в PHP 7.1.x »](migration71.deprecated.html)
    
-   [PHP Manual](index.html)
    
-   [Миграция с PHP 7.0.x на PHP 7.1.x](migration71.html)
    
-   Зміни, що ламають зворотну сумісність
    

## Зміни, що ламають зворотну сумісність

### Виклик виключення під час передачі функції недостатньої кількості аргументів

Раніше, якщо функція користувача викликалася з недостатньою кількістю аргументів, видавалося попередження. Тепер, замість попередження буде викликатися виняток класу Error. Ця зміна зачіпає лише функції користувача і не впливає на вбудовані. Наприклад:

```php
<?php
function test($param){}
test();
```

Результатом виконання цього прикладу буде щось подібне:

```
Fatal error: Uncaught ArgumentCountError: Too few arguments to function test(), 0 passed in %s on line %d and exactly 1 expected in %s:%d
```

### Заборона динамічного виклику функцій інтроспекції області видимості

Динамічні виклики певних функцій були заборонені (у вигляді `$func()` або `array_map('extract', ...)`, і т.д.) Ці функції перевіряють або модифікують об'єкти іншої області видимості, чим викликають неоднозначну та невизначену поведінку. Список таких функцій:

-   [assert()](function.assert.html) - з рядком як перший аргумент
-   [compact()](function.compact.html)
-   [extract()](function.extract.html)
-   [funcgetargs()](function.func-get-args.html)
-   [funcgetarg()](function.func-get-arg.html)
-   [funcnumargs()](function.func-num-args.html)
-   [getdefinedvars()](function.get-defined-vars.html)
-   [мбparsestr()](function.mb-parse-str.html) - з одним аргументом
-   [parsestr()](function.parse-str.html) - з одним аргументом

```php
<?php
(function () {
    $func = 'func_num_args';
    $func();
})();
```

Результат виконання цього прикладу:

```
Warning: Cannot call func_num_args() dynamically in %s on line %d
```

### Некоректні імена класів, інтерфейсів та трейтів

Наступні імена не можна використовувати як класи, інтерфейси або трейти:

-   void
-   [iterable](language.types.iterable.html)

### Перетворення числових рядків тепер враховує наукову нотацію

Цілочисленні операції та конвертації числових рядків тепер враховують наукову нотацію, включаючи приведення `(int)` та наступні функції: [intval()](function.intval.html) (З базою 10), [settype()](function.settype.html) [decbin()](function.decbin.html) [decoct()](function.decoct.html) і [dechex()](function.dechex.html)

### Виправлення алгоритму [мтrand()](function.mt-rand.html)

[мтrand()](function.mt-rand.html) тепер за замовчуванням використовує зафіксовану версію алгоритму "Вихор Мерсена". Якщо ви покладалися на детермінований висновок [мтsrand()](function.mt-srand.html), можна використовувати константу **`MT_RAND_PHP`** як другий, необов'язковий, параметр [мтsrand()](function.mt-srand.html) задля збереження старої (неправильної) реалізації.

### [rand()](function.rand.html) псевдонім для [мтrand()](function.mt-rand.html) і [srand()](function.srand.html) псевдонім для [мтsrand()](function.mt-srand.html)

[rand()](function.rand.html) і [srand()](function.srand.html) тепер є просто синонімами для [мтrand()](function.mt-rand.html) і [мтsrand()](function.mt-srand.html). Це означає, що виведення наступних функцій змінилося: [rand()](function.rand.html) [shuffle()](function.shuffle.html) [strshuffle()](function.str-shuffle.html) і [arrayrand()](function.array-rand.html)

### Заборона використання символу видалення з таблиці ASCII в ідентифікаторах

Символ видалення ASCII (`0x7F`) більше не можна використовувати в ідентифікаторах, не обгорнутих у лапки.

### Значення `error_log` змінено на `syslog`

Якщо ini-параметр `error_log` встановлений як `syslog`, то рівні помилок PHP проектуються на рівні помилок "syslog". Це дозволяє більш тонко логувати події, а не як раніше, коли вони записувалися з рівнем "notice".

### Деструктори не викликаються на незавершених об'єктах

Тепер деструктори ніколи не викликаються, якщо було викликано виключення у конструкторі об'єкта. Раніше ця поведінка залежала від того, чи було посилання на об'єкт поза конструктором (наприклад, у трасуванні виключення).

### [calluserfunc()](function.call-user-func.html) обробляє посилання на аргументи

Тепер [calluserfunc()](function.call-user-func.html) завжди викликає попередження, якщо викликається функція, що очікує посилання як параметри. Раніше це залежало від того, чи виклик був цілком певним.

Крім того, [calluserfunc()](function.call-user-func.html) і [calluserfuncarray()](function.call-user-func-array.html) більше не припиняють виконання функції у разі. Попередження "expected reference" буде викликано, але функція продовжить виконання.

### Оператор порожнього індексу більше не застосовується до рядків

Застосування оператора порожнього індексу до рядка (`$str[] = $x`) викликає фатальну помилку замість тихого перетворення змінної до масиву.

### Присвоєння через механізм доступу до елемента рядка за індексом стосовно порожнього рядка

Модифікація символу в порожньому рядку тепер працює так само, як і для не порожній. Тобто. запис по неіснуючому зміщенню призведе до перетворення не цілого чисельного зсуву до цілого числа, доповнення рядка до потрібної довжини символами пропуску і використання тільки першого символу з рядка, що присвоюється. Раніше в такій ситуації порожній рядок розглядався як порожній масив.

```php
<?php
$a = '';
$a[10] = 'foo';
var_dump($a);
?>
```

Результат виконання цього прикладу в PHP 7.0:

```
array(1) {
  [10]=>
  string(3) "foo"
}
```

Результат виконання цього прикладу в PHP 7.1:

```
string(11) "          f"
```

### Віддалені ini-директиви

Наступні ini-директиви були видалені:

-   `session.entropy_file`
-   `session.entropy_length`
-   `session.hash_function`
-   `session.hash_bits_per_character`

### Порядок масиву, коли елементи створені автоматично через присвоєння посилання, було змінено

Порядок розташування елементів масиву, створюваних присвоєнням за посиланням не створених на момент присвоєння елементів, було змінено. Наприклад:

```php
<?php
$array = [];
$array["a"] =& $array["b"];
$array["b"] = 1;
var_dump($array);
?>
```

Результат виконання цього прикладу в PHP 7.0:

```
array(2) {
  ["a"]=>
  &int(1)
  ["b"]=>
  &int(1)
}
```

Результат виконання цього прикладу в PHP 7.1:

```
array(2) {
  ["b"]=>
  &int(1)
  ["a"]=>
  &int(1)
}
```

### Порядок сортування еквівалентних елементів

Внутрішній алгоритм сортування був покращений, що може призвести до відмінності у порядку розташування еквівалентних елементів після сортування порівняно з попередніми версіями PHP.

> **Зауваження**
> 
> Не покладайтеся на порядок розташування еквівалентних елементів, оскільки він може змінитися будь-якої миті.

### Повідомлення для помилок ERECOVERABLE

Повідомлення для помилок ERECOVERABLE змінено з "Catchable fatal error" на "Recoverable fatal error".

### Параметр $options функції unserialize()

Тепер елемент `allowed_classes` параметра $options функції [unserialize()](function.unserialize.html) строго типізований, тобто якщо передати значення з типом, відмінним від array та bool, то unserialize() поверне **`false`** та викличе помилку рівня **`E_WARNING`**

### Конструктор DateTime використовує мікросекунди.

Тепер [DateTime](class.datetime.html) і [DateTimeImmutable](class.datetimeimmutable.html) використовують мікросекунди при створенні з поточним часом, або у явному вигляді, або з рядком відносного часу (наприклад, `"first day of next month"`). Це означає, що порівняння двох поспіль створених екземплярів класу швидше повертатиме **`false`** ніж **`true`**

```php
<?php
new DateTime() == new DateTime();
?>
```

### Виклик винятків [Error](class.error.html) замість фатальних помилок

Для модуля Date при некоректних даних серіалізації класів [DateTime](class.datetime.html) або [DatePeriod](class.dateperiod.html), або помилки ініціалізації часового поясу із серіалізованих даних, викидатиметься виняток [Error](class.error.html) з методів **wakeup()** або \*\*setstate()\*\*замість виклику фатальної помилки.

У модулі DBA функції маніпулювання даними (такі як [dbainsert()](function.dba-insert.html)) тепер викидатимуть виняток [Error](class.error.html) замість виклику фатальної помилки, що відловлюється, якщо ключ не містить рівно двох елементів.

У модулі DOM некоректна перевірка контексту схеми чи RelaxNG тепер викидатимуть виняток [Error](class.error.html) замість виклику фатальної помилки. Аналогічно, спроби зареєструвати клас вузла, який не розширює правильний базовий клас, спроби прочитати некоректну властивість або перезаписати властивість доступну тільки для читання викидатимуть виняток [Error](class.error.html)

У модулі IMAP адреса email довша 16385 байт тепер викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки.

Модуль Intl у разі виникнення помилки виклику батьківського конструктора у класі, що успадковує [Collator](class.collator.html) до виклику батьківських методів тепер викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки. Крім того, клонування об'єкта [Transliterator](class.transliterator.html) тепер викидатиме виняток [Error](class.error.html) у разі виникнення помилки клонування внутрішнього transliterator замість виклику фатальної помилки.

Модуль LDAP при вказівці невідомого типу модифікації в **ldapbatchmodify()** тепер викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки.

У модулі mbstring функції [мбereg()](function.mb-ereg.html) і [мбeregi()](function.mb-eregi.html) тепер викидатимуть виняток [ParseError](class.parseerror.html) у разі некоректного регулярного вираження або у разі використання опції 'e'.

У модулі Mcrypt [mcryptencrypt()](function.mcrypt-encrypt.html) і [mcryptdecrypt()](function.mcrypt-decrypt.html) тепер викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки, якщо mcrypt не ініціалізовано.

У модулі mysqli спроби прочитати некоректну властивість або перезаписати властивість доступну тільки для читання будуть викидати виняток [Error](class.error.html) замість виклику фатальної помилки.

У модулі Reflection невдале вилучення відображеного об'єкта або властивості об'єкта викидатимуть виняток [Error](class.error.html) замість виклику фатальної помилки.

У модулі сесій користувальницькі обробники сесії, які не повертають рядок для ідентифікатора сесії, викидатимуть виняток [Error](class.error.html) замість виклику фатальної помилки, коли буде викликано функцію для генерації ідентифікатора.

У модулі SimpleXML спроба створення безіменного чи дублюючого атрибуту викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки.

У модулі SPL спроба клонувати об'єкт **SplDirectory** викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки. Аналогічно, виклик [ArrayIterator::append()](arrayiterator.append.html) коли ітерація об'єкта закінчена буде викидати виняток [Error](class.error.html)

Функція [assert()](function.assert.html), коли їй переданий рядковий аргумент першим параметром, тепер викидатиме виняток [ParseError](class.parseerror.html) замість виклику фатальної помилки, що відловлюється, якщо PHP-код некоректний. Аналогічно, виклик [forwardstaticcall()](function.forward-static-call.html) за межами простору класу викидатиме виняток [Error](class.error.html)

У модулі Tidy ручне створення [tidyNode](class.tidynode.html) викидатиме виняток [Error](class.error.html)

У модулі WDDX циклічні посилання при серіалізації викидатимуть виняток [Error](class.error.html) замість виклику фатальної помилки.

У модулі XML-RPC циклічні посилання серіалізації будуть викидати виняток [Error](class.error.html) замість виклику фатальної помилки.

У модулі Zip метод [ZipArchive::addGlob()](ziparchive.addglob.html) викидатиме виняток [Error](class.error.html) замість виклику фатальної помилки, якщо відсутня підтримка glob.

### Лексично пов'язані змінні не можуть перевикористовувати імена

Змінні, прив'язані до [замыканию](functions.anonymous.html) через конструкцію `use`, не можуть використовувати ті ж імена, що і будь-які [superglobals](language.variables.predefined.html), $this або параметри. Наприклад, всі наведені функції спричинять фатальну помилку:

```php
<?php
$f = function () use ($_SERVER) {};
$f = function () use ($this) {};
$f = function ($param) use ($param) {};
```

### Змінено тип параметра long2ip()

Тепер [long2ip()](function.long2ip.html) очікує параметр типу int, а не string.

### Кодування та декодування JSON

INI-налаштування `serialize_precision` визначає точність серіалізації при кодуванні значень типу float.

Тепер декодування порожнього ключа призводить до появи властивості з пустим ім'ям, раніше ім'я властивості призводилося до значення `_empty_`

```php
<?php
var_dump(json_decode(json_encode(['' => 1])));
```

Результатом виконання цього прикладу буде щось подібне:

```
object(stdClass)#1 (1) {
  [""]=>
  int(1)
}
```

Під час передачі прапора **`JSON_UNESCAPED_UNICODE`** у функцію [jsonencode()](function.json-encode.html) послідовності U+2028 та U+2029 будуть екрановані.

### Зміна у семантиці параметрів [мбereg()](function.mb-ereg.html) і [мбeregi()](function.mb-eregi.html)

Третій параметр функцій [мбereg()](function.mb-ereg.html) і [мбeregi()](function.mb-eregi.html) `regs`) тепер встановлюється рівним порожньому масиву, якщо не було знайдено збігів. Раніше параметр залишався незмінним.

### Видалено підтримку потоку sslv2

Підтримка потоку sslv2 у OpenSSL видалена.

### Заборонено "return;" для типізованих повернень вже під час компіляції

Оператори повернення без аргументів у функціях, які оголошують тип значення, що повертається, тепер викликають **`E_COMPILE_ERROR`** (якщо тип повернення не оголошено як void), навіть якщо оператора повернення ніколи не буде досягнуто.