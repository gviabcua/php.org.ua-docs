SQL-ін'єкції

-   [« Шифрування сховища бази даних](security.database.storage.html)
    
-   [Повідомлення про помилки »](security.errors.html)
    
-   [PHP Manual](index.html)
    
-   [Безпека баз даних](security.database.html)
    
-   SQL-ін'єкції
    

## SQL-ін'єкції

Багато веб-розробників навіть не здогадуються, що SQL-запити можуть бути підроблені, і вважають, що SQL-запити завжди достовірні. Насправді, підроблені запити можуть обійти обмеження доступу, стандартну перевірку авторизації, а деякі види запитів можуть дати можливість виконувати команди операційної системи.

Пряме впровадження шкідливих інструкцій у SQL-запити - це методика, у якій хакер створює або змінює поточні SQL-запити для відображення прихованих даних, їх зміни або навіть виконання небезпечних команд операційної системи на сервері бази даних. Атака виконується на базі програми, що будує SQL-запити з введення користувача і статичних параметрів. Наступні приклади, на жаль, побудовано реальних фактах.

Завдяки відсутності перевірки введення користувача та з'єднання з базою даних під обліковим записом суперкористувача (або будь-якого іншого користувача, наділеного відповідними привілеями), зломщик може створити ще одного користувача БД з правами суперкористувача.

**Приклад #1 Посторінковий висновок результату... і створення суперкористувача в PostgreSQL**

```php
<?php

$offset = $argv[0]; // внимание, нет проверки вводимых данных!
$query  = "SELECT id, name FROM products ORDER BY name LIMIT 20 OFFSET $offset;";
$result = pg_query($conn, $query);

?>
```

Зазвичай користувачі клацають посилання 'вперед' і 'назад', внаслідок чого значення змінної $offset заноситься в URL. Скрипт очікує, що $offset – десяткове число. Однак, зломщик може спробувати зламати систему, приєднавши до URL додатковий рядок, оброблений функцією [urlencode()](function.urlencode.html)

0; insert into pgshadow(usename,usesysid,usesuper,usecatupd,passwd) select 'crack', usesysid, 't', 't', 'crack' from pgshadow where usename='postgres'; -

Якщо це станеться, скрипт надасть зломщику доступ до бази прав суперкористувача. Зауважимо, що значення `0;` використано для того, щоб задати правильне усунення першого запиту і коректно його завершити.

> **Зауваження**
> 
> Часто використовуваною технікою для ігнорування SQL-парсером частини запиту, що залишилася, є використання `--`, Що означає коментар.

Ще один можливий спосіб отримати паролі облікових записів у БД – атака сторінок, що надають пошук по базі. Зломщику потрібно лише перевірити, чи використовується в запиті змінна, що передається на сервер і необроблена належним чином. Це може бути один із фільтрів, що встановлюються на попередній сторінці, таких як `WHERE, ORDER BY, LIMIT` і `OFFSET`, що використовуються при побудові запитів `SELECT`. У випадку, якщо база даних, що використовується вами, підтримує конструкцію `UNION`, зломщик може приєднати до оригінального запиту ще один додатковий, для вилучення паролів користувача. Рекомендуємо використовувати тільки зашифровані паролі.

**Приклад #2 Лістинг статей... та деяких паролів (для будь-якої бази даних)**

```php
<?php

$query  = "SELECT id, name, inserted, size FROM products
           WHERE size = '$size'";
$result = odbc_exec($conn, $query);

?>
```

Статична частина запиту може комбінуватись з іншим `SELECT`запит, який виведе всі паролі:

## union select '1', concat(uname||'-'||passwd) as name, '1971-01-01', '0' від usertable;

Якщо цей запит (використовує `'` і `--`) приєднати до значення однієї зі змінних, що використовуються для формування $query, запит помітно перетвориться.

Команди UPDATE можуть також використовуватися для атаки. Знову ж таки, є загроза поділу інструкції на кілька частин та приєднання додаткового запиту. Також зломщик може видозмінити вираз `SET`. У цьому випадку потенційному зломщику необхідно мати деяку додаткову інформацію про структуру бази даних для успішного маніпулювання запитами. Цю інформацію можна отримати, проаналізувавши імена змінних, що використовуються у формі, або просто перебираючи всі найбільш поширені варіанти назви відповідних полів (а їх не так вже й багато).

**Приклад #3 Від відновлення пароля... до отримання додаткових привілеїв (для будь-якої бази даних)**

```php
<?php
$query = "UPDATE usertable SET pwd='$pwd' WHERE uid='$uid';";
?>
```

Але зловмисник може ввести значення `' or uid like'%admin%'` для змінної $uid для зміни пароля адміністратора або просто присвоїти змінної $pwd значення `hehehe', trusted=100, admin='yes` для отримання додаткових привілеїв. При виконанні запити переплітаються:

```php
<?php

// $uid: ' or uid like '%admin%
$query = "UPDATE usertable SET pwd='...' WHERE uid='' or uid like '%admin%';";

// $pwd: hehehe', trusted=100, admin='yes
$query = "UPDATE usertable SET pwd='hehehe', trusted=100, admin='yes' WHERE
...;";

?>
```

Жахливий приклад того, як на сервері баз даних можуть виконуватися команди операційної системи.

**Приклад #4 Виконання команд ОС на сервері (для бази MSSQL)**

```php
<?php

$query  = "SELECT * FROM products WHERE id LIKE '%$prod%'";
$result = mssql_query($query);

?>
```

Якщо зломщик введе значення `a%' exec master..xp_cmdshell 'net user test testpass /ADD' --` для змінної $prod, тоді запит $query буде виглядати так:

```php
<?php

$query  = "SELECT * FROM products
           WHERE id LIKE '%a%'
           exec master..xp_cmdshell 'net user test testpass /ADD' --%'";
$result = mssql_query($query);

?>
```

MSSQL сервер виконує SQL-команди в пакетному режимі, у тому числі операції з закладу локальних облікових записів бази даних. У випадку, якщо програма працює з привілеями адміністратора `sa` і сервіс MSSQL запущений з необхідними привілеями, виконавши наведені вище дії, зломщик отримає аккаунт для доступу до сервера.

> **Зауваження**
> 
> Деякі приклади, що наведені в цьому розділі, стосуються конкретної бази даних. Не означає, що аналогічні атаки інші програмні продукти неможливі. Працездатність вашої бази даних може бути порушена будь-яким іншим способом.

![Робочий приклад проблем, викликаних SQL-ін'єкцією](images/fa7c5b5f326e3c4a6cc9db19e7edbaf0-xkcd-bobby-tables.png)

Авторство зображення належить [» xkcd](http://xkcd.com/327)

### Способи захисту

Хоча, як і раніше, очевидно, що зломщик повинен мати принаймні деякі знання про структуру бази даних, щоб провести успішну атаку, отримати цю інформацію дуже просто. Наприклад, якщо база даних є частиною open-source або іншого публічно доступного програмного пакета з інсталяцією за промовчанням, ця інформація є повністю відкритою та доступною. Ці дані також можуть бути отримані із закритого проекту, навіть якщо він закодований, ускладнений, або скомпільований, і навіть з вашого особистого коду через відображення повідомлень про помилки. До інших методів відноситься використання поширених (легко вгадуваних) назв таблиць та стовпців. Наприклад, форма логіна, яка використовує таблицю 'users' з назвами стовпців 'id', 'username' та 'password'.

Більшість успішних атак ґрунтується на коді, написаному без урахування відповідних вимог безпеки. Не довіряйте жодним даних, особливо якщо вони надходять з боку клієнта, навіть якщо це списки у формі, приховані поля або куки. Перший наведений приклад показує, як подібні запити можуть призвести до катастрофи.

-   Ніколи не з'єднуйтесь з базою даних, використовуючи обліковий запис власника бази даних або суперкористувача. Завжди намагайтеся використовувати спеціально створені користувачі з максимально обмеженими правами.
    
-   використовуйте підготовлені вирази із прив'язаними змінними. Ця можливість надається модулями [PDO](pdo.prepared-statements.html) [MySQLi](mysqli.quickstart.prepared-statements.html) та іншими бібліотеками.
    
-   Завжди перевіряйте введені дані на відповідність очікуваного типу. У PHP є безліч функцій для перевірки даних: починаючи від найпростіших [функцій для роботи зі змінними](ref.var.html) і [функций определения типа символов](ref.ctype.html) (таких як [ісnumeric()](function.is-numeric.html) і [ctypedigit()](function.ctype-digit.html) відповідно) та закінчуючи [Perl-сумісними регулярними виразами](ref.pcre.html)
    
-   У випадку, якщо програма очікує цифрове введення, застосуйте функцію [ctypedigit()](function.ctype-digit.html) для перевірки введених даних, або примусово вкажіть їх тип за допомогою [settype()](function.settype.html), або просто використовуйте числове подання за допомогою функції [sprintf()](function.sprintf.html)
    
    **Приклад #5 Безпечніша реалізація посторінкової навігації**
    
    ```php
    <?php
    
    settype($offset, 'integer');
    $query = "SELECT id, name FROM products ORDER BY name LIMIT 20 OFFSET $offset;";
    
    // обратите внимание на формат %d, использование %s было бы бессмысленно
    $query = sprintf("SELECT id, name FROM products ORDER BY name LIMIT 20 OFFSET %d;",
                     $offset);
    
    ?>
    ```
    
-   Якщо на рівні бази даних не підтримуються прив'язані змінні, то завжди екрануйте будь-які нечислові дані, які використовуються в запитах до БД за допомогою спеціальних функцій, що екранують, специфічних для використовуваної вами бази даних (наприклад, [mysqlrealescapestring()](function.mysql-real-escape-string.html) **sqliteescapestring()** і т.д.). Загальні функції, такі як [addslashes()](function.addslashes.html) корисні лише у певних випадках (наприклад MySQL в однобайтному кодуванні з вимкненим NOBACKSLASHESCAPES), тому краще уникати їх використання.
    
-   У жодному разі не виводьте жодної інформації про БД, особливо про її структуру. Також ознайомтесь із відповідними розділами документації: "[Повідомлення про помилки](security.errors.html)"і"[Функции обработки и логирования ошибок](ref.errorfunc.html)".
    
-   Ви можете використовувати процедури, що зберігаються, і заздалегідь визначені курсори для абстрагованої роботи з даними, не надаючи користувачам прямого доступу до даних і уявлень, але це рішення має свої особливості.
    

Крім того, ви можете логувати запити у вашому скрипті або на рівні бази даних, якщо вона це підтримує. Очевидно, що логування не може запобігти завданню шкоди, але може допомогти при трасуванні зламаної програми. Лог-файл корисний не сам собою, а інформацією, яка в ньому міститься. Причому, як правило, корисно логувати всі можливі деталі.